---
title: "DATASCI 306, Fall 2025, Final Group Project"
author: "Group <num>: Andre Couwlier, Stephen Elsinger, Maximus Lo Bianco, Talia Parnes, Lucia Zhang"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

```

Throughout this course, you've dedicated yourself to refining your analytical abilities using R programming language. These skills are highly coveted in today's job market!

Now, for the semester project, you'll apply your learning to craft a compelling `Data Story` that can enrich your portfolio and impress prospective employers. Collaborating with a team (up to 5 members of your choosing), you'll construct a Data Story using the data provided in the `data` folder.
This data is downloaded from: https://data.cdc.gov/browse?sortBy=relevance&pageSize=20&q=Adult+Tobacco+Consumption+In+The+U.S.%2C+2000-Present&page=1


## Deliverable

### 1.  Requirement-1 (4 pt)

You should show at least 4 steps you adopt to clean and/or transform the dataset. Some of the steps you might take are; merging all the data into one dataframe, converting datatypes, creating additional columns, cleaning column names etc.

```{r}

age <- read_csv("data/Age-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

employment <- read_csv("data/Employment-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

income <- read_csv("data/Income-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

m_health <- read_csv("data/Mental_Health-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

race <- read_csv("data/Race_and_Ethnic_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

```

```{r}
# Merging all tables into one. This only requires bind_rows since all variable names are the same across all five tables.

tobacco_chr <- bind_rows(age, employment, income, m_health, race)
```

```{r}
# Converting quantitative variables to numeric datatypes

tobacco <- tobacco_chr |>
  mutate(across(c(`Cigarette Use Prevalence % (Focus group)`,
                   `Cigarette Use Prevalence % (Reference group)`,
                   `Disparity Value`),
                as.numeric))
```

```{r}
n_distinct(tobacco$`Tobacco Use`)

# The "tobacco use" column is useless since it only says "Cigarette Use Among Adults". Therefore let's get rid of it.
tobacco <- tobacco |>
  select(-`Tobacco Use`)
```

```{r}
tobacco <- tobacco |>
  group_by(`Year`,
           `State`,
           `Demographic`,
           `Comparing (Focus group)`,
           `Cigarette Use Prevalence % (Focus group)`)|>
  mutate(`Mean Disparity Value (Focus Group)` = mean(`Disparity Value`))

# Creating a new column which assigns each state to a designated region based on the Census Regions and Divisions of the United States.

tobacco_region <- tobacco |>
  mutate(
    region = case_when(
      State %in% c(
        "Maine","New Hampshire","Vermont","Massachusetts","Rhode Island","Connecticut",
        "New York","New Jersey","Pennsylvania"
      ) ~ "Northeast",
      
      State %in% c(
        "Ohio","Indiana","Illinois","Michigan","Wisconsin",
        "Minnesota","Iowa","Missouri","North Dakota","South Dakota","Nebraska","Kansas"
      ) ~ "Midwest",
      
      State %in% c(
        "Delaware","Maryland","District of Columbia","Virginia","West Virginia",
        "North Carolina","South Carolina","Georgia","Florida",
        "Kentucky","Tennessee","Mississippi","Alabama",
        "Oklahoma","Texas","Arkansas","Louisiana"
      ) ~ "South",
      
      State %in% c(
        "Idaho","Montana","Wyoming","Nevada","Utah","Colorado","Arizona","New Mexico",
        "Alaska","Washington","Oregon","California","Hawaii"
      ) ~ "West",))

tobacco_region

#To check for NA values.
tobacco_region |>
  filter(is.na(region))
```


### 2. Requirement - 2 (20 pt)

You need to plot 10 different diagrams to show correlations, frequencies, and/or relationships between various variables with plots of 5 different types (bar, line, heatmap, facet, etc.). Every plot should have a title and the x/y axis should have legible labels without any label overlaps for full credit. Provide a summary of your interpretations from the plots after each one. Each chart should be meaningful by itself.
```{r}

tobacco_region |>
  filter(Year == 2022, Demographic == "Race and Ethnicity") |>
 
  group_by(Race = `Comparing (Focus group)`, region) |>
  summarize(race_mean = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = TRUE)) |>
 
  ggplot(aes(x = region, y = race_mean, fill = Race)) + geom_col(position = "dodge") +
  labs(title = "Average US Adult Smoking Rates by Race and Region in 2022",
       x = "Region", y = "Average Smoking Rate (%)", fill = "Race")

```

```{r}

tobacco_region |>
  ungroup() |>
  filter(Year %in% c(2011, 2023)) |>
  select(Year, `Comparing (Focus group)`, `Disparity Value`) |>
  drop_na(`Disparity Value`) |>
  group_by(Year) |>
  slice_max(`Disparity Value`, n = 100, with_ties = F) |>
  add_count(`Comparing (Focus group)`, name = "n_fg") |>
  mutate(FocusGroup2 = ifelse(n_fg <= 3,
                              "Other",
                              `Comparing (Focus group)`)) |>
  ggplot(aes(x = "", fill = FocusGroup2)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") +
  facet_wrap(~ Year) +
  labs(title = "Share of Top 100 Smoking Disparity Values by Factor (2011 vs 2023)",
      x = NULL, y = NULL,
      fill = "Factor") +
  theme_void()
```

```{r}
tobacco_region |> group_by(`Year`, region) |> 
  summarize(avg = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = T)) |>
  
  ggplot() + geom_line(aes(x = `Year`, 
                           y = avg, color = region)) +
    labs(title = "Average Smoking Rate Over Time by Focus Group's Region",
         y = "Average Cigarette Smoking Rate (as a %)",
         color = "Region")
```

```{r}
tobacco_region |> filter(`Demographic` == "Income") |> group_by(`Comparing (Focus group)`, `region`) |>
  summarize(avg = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = T)) |>
  
  ggplot(aes(fill = `Comparing (Focus group)`, y = avg, x = region)) + geom_col(position = "dodge") +
    labs(title = "Average Smoking Rate by Focus Group's Income and Region",
         x = "Region",
         y = "Average Cigarette Smoking Rate (as a %)",
         fill = "Income")
```
```{r}
m_health_numeric <- m_health |>
  mutate(
    `Cigarette Use Prevalence % (Focus group)` =
      as.numeric(`Cigarette Use Prevalence % (Focus group)`)
  )
ggplot(m_health_numeric,
  aes(x = Year,
    y = `Cigarette Use Prevalence % (Focus group)`,
    color = `Comparing (Focus group)`)) +
  geom_point(alpha = 0.2) +
  geom_smooth(se = FALSE) + 
  labs(title = "Smoking Prevalence Over Time by Mental Health Group",
    x = "Year",
    y = "Smoking Prevalence (%), Focus Group",
    color = "Mental Health Group") 
```
```{r}
tobacco_region |>
  filter(Demographic == "Employment") |>
  ggplot(aes(
    x = `Comparing (Focus group)`,
    y = `Cigarette Use Prevalence % (Focus group)`,
    fill = `Comparing (Focus group)`
  )) +
  geom_violin() +
  labs(
    title = "Distribution of Smoking Rates by Employment Status",
    x = "Employment Status (Focus Group)",
    y = "Cigarette Use Prevalence (%)", fill = "Employment Status"
  ) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```


```{r}
tobacco |>
  filter(`Comparing (Focus group)` == "Less than $20,000" &
         `To (Reference group)` == "$75,000 or above") |>
  group_by(Year) |>
  summarize(avg_disp = mean(`Disparity Value`, na.rm = T)) |>
  ggplot(aes(x = Year, y = avg_disp)) + geom_line() + labs(title = "Average Disparity in smoking rates between low income 
                                                           and high income individuals over time", y = "Average Disparity")
```

```{r}
tobacco_region |>
  ungroup() |>
  filter(Year == 2023) |>
  select(Demographic, `Comparing (Focus group)`, `Disparity Value`) |>
  group_by(Demographic, `Comparing (Focus group)`) |>
  summarize(avg_disp = mean(`Disparity Value`, na.rm = T)) |>
  filter(avg_disp > 1) |>
  ggplot(aes(x = avg_disp,
             y = reorder(`Comparing (Focus group)`, avg_disp),
             fill = Demographic)) +
  geom_col() + labs(title = "2023 Focus Groups that on Average were more likely to 
                    smoke compared to their reference group",
                    x = "Average Disparity",
                     y = "Focus Group")
```

```{r}
tobacco_region |>
  filter(Demographic == "Mental Health") |>
  ggplot(aes(
    x = `Comparing (Focus group)`,
    y = `Cigarette Use Prevalence % (Focus group)`,
    fill = `Comparing (Focus group)`
  )) +
  geom_boxplot() +
  labs(
    title = "Smoking Rates by Mental Health Status",
    x = "Mental Health Category",
    y = "Cigarette Use Prevalence (%)", fill = "Mental Health") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```

```{r}
race_boxplot <- tobacco_region |>
  filter(Demographic == "Race and Ethnicity") |>
  select(Race = `Comparing (Focus group)`,
         Smoking = `Cigarette Use Prevalence % (Focus group)`)
ggplot(race_boxplot,
       aes(x = Race, y = Smoking, fill = Race)) +
  geom_boxplot() +
  labs(title = "Distribution of Focus Group Smoking Prevalence by Race and Ethnicity",
    x = "Race / Ethnicity",
    y = "Cigarette Use Prevalence % (Focus group)",
    fill = "Race / Ethnicity") +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))

```


### 3. Requirement - 3 (5 pt)

By this phase, you have a pretty good understanding of your data. Now, you will develop a predictive Machine Learning model to forecast a specified target outcome. For predictor selection, you must apply the feature selection techniques covered in Lectures 19 and 20. Provide a detailed justification for the final set of predictors chosen to receive full credit.

Build an interactive shiny app that allows the user to select or input values and then make predictions using your model. You are required to build the shiny app just for the prediction section of your project. Although we will accept if you create a shiny app for your entire project (not required)


### 4. Requirement - 4 (1 pt)

You should have a conclusion, highlighting the main insights you were able to derive from your analysis. 

This is an open ended project where every team will come up with their own unique insights. We would like to see what each team comes up with.

## Submission

* You will upload the zip file containing your final.Rmd, final.pdf files covering the EDA and app.R file for your shiny app, as a deliverable to Canvas

* You will present your findings by creating a video of a maximum of 15 minutes duration, explaining the code and the workings of your project; all team members should explain their part in the project to receive credit. You will share the video URL on Canvas for credit.

It is not necessary to prepare slides (if you do it doesn't hurt) for the presentation. You may speak by showing the diagrams and/or code from your laptop.  Every team member should explain their part in the project along with the insights they derived by explaining the charts and summaries for full credit to each member. An easy way to get this accomplished is to open a Zoom meeting and everyone take turns in explaining while you record the meeting. Add the URL of this recording to Canvas.

Your project will be evaluated for its meaningful/insightful EDA and predictions.

------------------------------------------------------------------

## Hints

Some answers you may try to find in this dataset could be:

* Are smoking disparities related to income getting worse or better over time?
* Which racial or ethnic group faces the greatest inequality in smoking rates compared to the majority population?
* Do people with frequent mental distress have a much higher smoking disparity than people with disabilities?
* Which 5 focus groups have the highest average disparity over the entire period?

These questions could just get you started but as an analyst you should hone the skills of asking good questions and this project will get you that practice.


## Machine Learning Model Development:

You could build  a regression model to predict the DisparityValue. Features may include, Year, disparity category, specific focus group etc. Extract and plot the feature importance to select the features. 

## Summary

Your summary might answer questions like; 

* What were the most significant trends and predictors of smoking disparity? 
* Which populations should be prioritized for smoking cessation programs? etc.  
You may also include ideas for future analysis and any limitations you came across with the current dataset


```{r}
# app.R
library(shiny)
library(dplyr)

# ---- Load data ----
tobacco_region <-tobacco_region

years  <- sort(unique(tobacco_region$Year))
states <- sort(unique(tobacco_region$State))
demos  <- unique(tobacco_region$Demographic)

# ---- UI ----
ui <- fluidPage(
  titlePanel("Compare Cigarette Use Between Two Groups"),

  sidebarLayout(
    sidebarPanel(
      h3("Group 1"),
      selectInput("g1_year",  "Year:",   choices = years,  selected = max(years)),
      selectInput("g1_state", "State:",  choices = states),
      selectInput("g1_demo",  "Demographic:", choices = demos),
      uiOutput("g1_focus_ui"),

      tags$hr(),

      h3("Group 2"),
      selectInput("g2_year",  "Year:",   choices = years,  selected = max(years)),
      selectInput("g2_state", "State:",  choices = states),
      selectInput("g2_demo",  "Demographic:", choices = demos),
      uiOutput("g2_focus_ui")
    ),

    mainPanel(
      h3("Comparison results"),
      textOutput("g1_text"),
      textOutput("g2_text"),
      br(),
      
      strong(textOutput("ratio_text")),   # NEW: Disparity ratio sentence
      br(), br(),
      
      h3("Smoking Prevalence by Race and Ethnicity"),
  plotOutput("race_boxplot"),
  br(), br(),
      
      h4("Data used (state-level averages)"),
      tableOutput("summary_table")
    )
  )
)

# ---- SERVER ----
server <- function(input, output, session) {

  # Helper: focus group options for a given state/year/demographic
  focus_choices <- function(year, state, demo) {
    tobacco_region %>%
      filter(
        Year == year,
        State == state,
        Demographic == demo
      ) %>%
      pull(`Comparing (Focus group)`) %>%
      unique() %>%
      sort()
  }

  # Dynamic dropdowns
  output$g1_focus_ui <- renderUI({
    choices <- focus_choices(input$g1_year, input$g1_state, input$g1_demo)
    selectInput("g1_focus", "Group 1: Focus group", choices = choices)
  })

  output$g2_focus_ui <- renderUI({
    choices <- focus_choices(input$g2_year, input$g2_state, input$g2_demo)
    selectInput("g2_focus", "Group 2: Focus group", choices = choices)
  })

  # Helper: get prevalence 
  get_prev <- function(year, state, demo, focus) {
    df <- tobacco_region %>%
      filter(
        Year == year,
        State == state,
        Demographic == demo,
        `Comparing (Focus group)` == focus
      )

    if (nrow(df) == 0) return(NA_real_)

    mean(df$`Cigarette Use Prevalence % (Focus group)`, na.rm = TRUE)
  }

  # Reactive prevalences
  g1_prev <- reactive({
    req(input$g1_year, input$g1_state, input$g1_demo, input$g1_focus)
    get_prev(input$g1_year, input$g1_state, input$g1_demo, input$g1_focus)
  })

  g2_prev <- reactive({
    req(input$g2_year, input$g2_state, input$g2_demo, input$g2_focus)
    get_prev(input$g2_year, input$g2_state, input$g2_demo, input$g2_focus)
  })

  # --- Display prevalence text ---
  output$g1_text <- renderText({
    p <- g1_prev()
    if (is.na(p)) return("No data for Group 1.")
    paste0(
      "Group 1 (", input$g1_state, ", ", input$g1_year, ", ",
      input$g1_demo, " = ", input$g1_focus,
      ") has an estimated cigarette-use prevalence of ",
      round(p, 1), "%."
    )
  })

  output$g2_text <- renderText({
    p <- g2_prev()
    if (is.na(p)) return("No data for Group 2.")
    paste0(
      "Group 2 (", input$g2_state, ", ", input$g2_year, ", ",
      input$g2_demo, " = ", input$g2_focus,
      ") has an estimated cigarette-use prevalence of ",
      round(p, 1), "%."
    )
  })

  # --- DISPARITY RATIO (FG% / RG%) ---
  output$ratio_text <- renderText({
    p1 <- g1_prev()
    p2 <- g2_prev()

    if (is.na(p1) || is.na(p2) || p2 == 0) {
      return("Cannot compute disparity ratio.")
    }

    ratio <- p1 / p2

    # Interpretation text
    if (ratio > 1) {
      paste0(
        "Group 1 is ", round(ratio, 2),
        "× more likely to smoke than Group 2."
      )
    } else if (ratio < 1) {
      paste0(
        "Group 1 is ", round(1/ratio, 2),
        "× less likely to smoke than Group 2."
      )
    } else {
      "Both groups smoke at the same rate (ratio = 1.0)."
    }
  })

  # --- Summary Table ---
  output$summary_table <- renderTable({
    data.frame(
      Group = c("Group 1", "Group 2"),
      Year  = c(input$g1_year, input$g2_year),
      State = c(input$g1_state, input$g2_state),
      Demographic = c(input$g1_demo, input$g2_demo),
      FocusGroup  = c(input$g1_focus, input$g2_focus),
      Prevalence_percent = c(g1_prev(), g2_prev())
    )
  })
}

shinyApp(ui = ui, server = server)
```


```{r}
library(shiny)
library(dplyr)
library(ggplot2)

# ---- Data ----
# Assumes tobacco_region is already in your environment.
# If not, load it with read.csv(...) here.
years  <- sort(unique(tobacco_region$Year))
states <- sort(unique(tobacco_region$State))
demos  <- unique(tobacco_region$Demographic)

# ---- UI ----
ui <- fluidPage(
  titlePanel("Compare Cigarette Use Between Two Groups"),

  sidebarLayout(
    sidebarPanel(
      h3("Group 1"),
      selectInput("g1_year",  "Year:",   choices = years,  selected = max(years)),
      selectInput("g1_state", "State:",  choices = states),
      selectInput("g1_demo",  "Demographic:", choices = demos),
      uiOutput("g1_focus_ui"),

      tags$hr(),

      h3("Group 2"),
      selectInput("g2_year",  "Year:",   choices = years,  selected = max(years)),
      selectInput("g2_state", "State:",  choices = states),
      selectInput("g2_demo",  "Demographic:", choices = demos),
      uiOutput("g2_focus_ui")
    ),

    mainPanel(
      h3("Comparison Results"),
      textOutput("g1_text"),
      textOutput("g2_text"),
      br(),
      strong(textOutput("ratio_text")),
      br(), br(),

      h3("Smoking Prevalence by Race and Ethnicity"),
      plotOutput("race_boxplot"),
      br(), br(),

      h4("Data Used (State-Level Averages)"),
      tableOutput("summary_table")
    )
  )
)

# ---- SERVER ----
server <- function(input, output, session) {

  # helper: focus choices
  focus_choices <- function(year, state, demo) {
    tobacco_region %>%
      filter(
        Year == year,
        State == state,
        Demographic == demo
      ) %>%
      pull(`Comparing (Focus group)`) %>%
      unique() %>%
      sort()
  }

  output$g1_focus_ui <- renderUI({
    selectInput(
      "g1_focus", "Group 1: Focus group",
      choices = focus_choices(input$g1_year, input$g1_state, input$g1_demo)
    )
  })

  output$g2_focus_ui <- renderUI({
    selectInput(
      "g2_focus", "Group 2: Focus group",
      choices = focus_choices(input$g2_year, input$g2_state, input$g2_demo)
    )
  })

  # helper: prevalence
  get_prev <- function(year, state, demo, focus) {
    df <- tobacco_region %>%
      filter(
        Year == year,
        State == state,
        Demographic == demo,
        `Comparing (Focus group)` == focus
      )
    if (nrow(df) == 0) return(NA_real_)
    mean(df$`Cigarette Use Prevalence % (Focus group)`, na.rm = TRUE)
  }

  g1_prev <- reactive({
    req(input$g1_year, input$g1_state, input$g1_demo, input$g1_focus)
    get_prev(input$g1_year, input$g1_state, input$g1_demo, input$g1_focus)
  })

  g2_prev <- reactive({
    req(input$g2_year, input$g2_state, input$g2_demo, input$g2_focus)
    get_prev(input$g2_year, input$g2_state, input$g2_demo, input$g2_focus)
  })

  output$g1_text <- renderText({
    p <- g1_prev()
    if (is.na(p)) return("No data for Group 1.")
    paste0(
      "Group 1 (", input$g1_state, ", ", input$g1_year, ", ",
      input$g1_demo, " = ", input$g1_focus,
      ") has an estimated cigarette-use prevalence of ",
      round(p, 1), "%."
    )
  })

  output$g2_text <- renderText({
    p <- g2_prev()
    if (is.na(p)) return("No data for Group 2.")
    paste0(
      "Group 2 (", input$g2_state, ", ", input$g2_year, ", ",
      input$g2_demo, " = ", input$g2_focus,
      ") has an estimated cigarette-use prevalence of ",
      round(p, 1), "%."
    )
  })

  output$ratio_text <- renderText({
    p1 <- g1_prev()
    p2 <- g2_prev()
    if (is.na(p1) || is.na(p2) || p2 == 0) {
      return("Cannot compute disparity ratio.")
    }
    ratio <- p1 / p2
    if (ratio > 1) {
      paste0("Group 1 is ", round(ratio, 2),
             "× more likely to smoke than Group 2.")
    } else if (ratio < 1) {
      paste0("Group 1 is ", round(1 / ratio, 2),
             "× less likely to smoke than Group 2.")
    } else {
      "Both groups smoke at the same rate (ratio = 1.0)."
    }
  })

  # race boxplot
  output$race_boxplot <- renderPlot({
    race_boxplot <- tobacco_region %>%
      filter(Demographic == "Race and Ethnicity") %>%
      select(
        Race = `Comparing (Focus group)`,
        Smoking = `Cigarette Use Prevalence % (Focus group)`
      )

    ggplot(race_boxplot,
           aes(x = Race, y = Smoking, fill = Race)) +
      geom_boxplot() +
      labs(
        title = "Distribution of Focus Group Smoking Prevalence by Race and Ethnicity",
        x = "Race / Ethnicity",
        y = "Cigarette Use Prevalence % (Focus group)",
        fill = "Race / Ethnicity"
      ) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 25, hjust = 1))
  })

  output$summary_table <- renderTable({
    data.frame(
      Group = c("Group 1", "Group 2"),
      Year  = c(input$g1_year, input$g2_year),
      State = c(input$g1_state, input$g2_state),
      Demographic = c(input$g1_demo, input$g2_demo),
      FocusGroup  = c(input$g1_focus, input$g2_focus),
      Prevalence_percent = c(g1_prev(), g2_prev())
    )
  })
}

shinyApp(ui = ui, server = server)

```



