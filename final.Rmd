---
title: "DATASCI 306, Fall 2025, Final Group Project"
author: "Group 34: Andre Couwlier, Stephen Elsinger, Maximus Lo Bianco, Talia Parnes, Lucia Zhang"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

Throughout this course, you've dedicated yourself to refining your analytical abilities using R programming language. These skills are highly coveted in today's job market!

Now, for the semester project, you'll apply your learning to craft a compelling `Data Story` that can enrich your portfolio and impress prospective employers. Collaborating with a team (up to 5 members of your choosing), you'll construct a Data Story using the data provided in the `data` folder.
This data is downloaded from: https://data.cdc.gov/browse?sortBy=relevance&pageSize=20&q=Adult+Tobacco+Consumption+In+The+U.S.%2C+2000-Present&page=1


## Deliverable

### 1.  Requirement-1 (4 pt)

You should show at least 4 steps you adopt to clean and/or transform the dataset. Some of the steps you might take are; merging all the data into one dataframe, converting datatypes, creating additional columns, cleaning column names etc.

```{r}

age <- read_csv("data/Age-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

employment <- read_csv("data/Employment-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

income <- read_csv("data/Income-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

m_health <- read_csv("data/Mental_Health-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

race <- read_csv("data/Race_and_Ethnic_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv")

```

```{r}
# Merging all tables into one. This only requires bind_rows since all variable names are the same across all five tables.

tobacco_chr <- bind_rows(age, employment, income, m_health, race)
```

```{r}
# Converting quantitative variables to numeric datatypes

tobacco <- tobacco_chr |>
  mutate(across(c(`Cigarette Use Prevalence % (Focus group)`,
                   `Cigarette Use Prevalence % (Reference group)`,
                   `Disparity Value`),
                as.numeric))
```

```{r}
n_distinct(tobacco$`Tobacco Use`)

# The "tobacco use" column is useless since it only says "Cigarette Use Among Adults". Therefore let's get rid of it.
tobacco <- tobacco |>
  select(-`Tobacco Use`)
```

```{r}

# Creating a new column which assigns each state to a designated region based on the Census Regions and Divisions of the United States.

tobacco_region <- tobacco |>
  mutate(
    region = case_when(
      State %in% c(
        "Maine","New Hampshire","Vermont","Massachusetts","Rhode Island","Connecticut",
        "New York","New Jersey","Pennsylvania"
      ) ~ "Northeast",
      
      State %in% c(
        "Ohio","Indiana","Illinois","Michigan","Wisconsin",
        "Minnesota","Iowa","Missouri","North Dakota","South Dakota","Nebraska","Kansas"
      ) ~ "Midwest",
      
      State %in% c(
        "Delaware","Maryland","District of Columbia","Virginia","West Virginia",
        "North Carolina","South Carolina","Georgia","Florida",
        "Kentucky","Tennessee","Mississippi","Alabama",
        "Oklahoma","Texas","Arkansas","Louisiana"
      ) ~ "South",
      
      State %in% c(
        "Idaho","Montana","Wyoming","Nevada","Utah","Colorado","Arizona","New Mexico",
        "Alaska","Washington","Oregon","California","Hawaii"
      ) ~ "West",))

tobacco_region

#To check for NA values.
tobacco_region |>
  filter(is.na(region))
```


### 2. Requirement - 2 (20 pt)

You need to plot 10 different diagrams to show correlations, frequencies, and/or relationships between various variables with plots of 5 different types (bar, line, heatmap, facet, etc.). Every plot should have a title and the x/y axis should have legible labels without any label overlaps for full credit. Provide a summary of your interpretations from the plots after each one. Each chart should be meaningful by itself.
```{r}
#Graph 1
tobacco_region |> group_by(`Year`, region) |> 
  summarize(avg = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = T)) |>
  
  ggplot() + geom_line(aes(x = `Year`, 
                           y = avg, color = region)) +
    labs(title = "Average Smoking Rate Over Time by Focus Group's Region",
         y = "Average Cigarette Smoking Rate (as a %)",
         color = "Region")
```

```{r}
#Graph 2
tobacco |>
  filter(`Comparing (Focus group)` == "Less than $20,000" &
         `To (Reference group)` == "$75,000 or above") |>
  group_by(Year) |>
  summarize(avg_disp = mean(`Disparity Value`, na.rm = T)) |>
  ggplot(aes(x = Year, y = avg_disp)) + geom_line() +
  labs(title = "Average Disparity in Smoking Rates Between Low Income
                and High Income Individuals Over Time",
       y = "Average Disparity")
```

```{r}
#Graph 3
m_health_numeric <- m_health |>
  mutate(
    `Cigarette Use Prevalence % (Focus group)` =
      as.numeric(`Cigarette Use Prevalence % (Focus group)`)
  )
ggplot(m_health_numeric,
  aes(x = Year,
    y = `Cigarette Use Prevalence % (Focus group)`,
    color = `Comparing (Focus group)`)) +
  geom_point(alpha = 0.2) +
  geom_smooth(se = FALSE) + 
  labs(title = "Smoking Prevalence Over Time by Mental Health Group",
    x = "Year",
    y = "Smoking Prevalence (%), Focus Group",
    color = "Mental Health Group")
```

```{r}
#Graph 4
tobacco_region |> filter(`Demographic` == "Income") |> group_by(`Comparing (Focus group)`, `region`) |>
  summarize(avg = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = T)) |>
  
  ggplot(aes(fill = `Comparing (Focus group)`, y = avg, x = region)) + geom_col(position = "dodge") +
    labs(title = "Average Smoking Rate by Focus Group's Income and Region",
         x = "Region",
         y = "Average Cigarette Smoking Rate (as a %)",
         fill = "Income")
```

```{r}
#Graph 5
tobacco_region |>
  filter(Year == 2022, Demographic == "Race and Ethnicity") |>
 # The year is 2022 because there was no data for people of the Asian group in 2023.
  
  group_by(Race = `Comparing (Focus group)`, region) |>
  summarize(race_mean = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = TRUE)) |>
 
  ggplot(aes(x = region, y = race_mean, fill = Race)) + geom_col(position = "dodge") +
  labs(title = "Average US Adult Smoking Rates by Race and Region in 2022",
       x = "Region", y = "Average Smoking Rate (%)", fill = "Race")
```

```{r}
#Graph 6
tobacco_region |>
  filter(Demographic == "Mental Health") |>
  ggplot(aes(
    x = `Comparing (Focus group)`,
    y = `Cigarette Use Prevalence % (Focus group)`,
    fill = `Comparing (Focus group)`
  )) +
  geom_boxplot() +
  labs(
    title = "Smoking Rates by Mental Health Status",
    x = "Mental Health Category",
    y = "Cigarette Use Prevalence (%)", fill = "Mental Health") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```

```{r}
#Graph 7
race_boxplot <- tobacco_region |>
  filter(Demographic == "Race and Ethnicity") |>
  select(Race = `Comparing (Focus group)`,
         Smoking = `Cigarette Use Prevalence % (Focus group)`)
ggplot(race_boxplot,
       aes(x = Race, y = Smoking, fill = Race)) +
  geom_boxplot() +
  labs(title = "Distribution of Focus Group Smoking Prevalence by Race and Ethnicity",
    x = "Race / Ethnicity",
    y = "Cigarette Use Prevalence % (Focus group)",
    fill = "Race / Ethnicity") +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))
```

```{r}
#Graph 8
tobacco_region |>
  filter(Demographic == "Employment") |>
  ggplot(aes(
    x = `Comparing (Focus group)`,
    y = `Cigarette Use Prevalence % (Focus group)`,
    fill = `Comparing (Focus group)`
  )) +
  geom_violin() +
  labs(
    title = "Distribution of Smoking Rates by Employment Status",
    x = "Employment Status (Focus Group)",
    y = "Cigarette Use Prevalence (%)", fill = "Employment Status"
  ) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```

```{r}
#Graph 9
tobacco_region |>
  ungroup() |>
  filter(Year %in% c(2011, 2023)) |>
  select(Year, `Comparing (Focus group)`, `Disparity Value`) |>
  drop_na(`Disparity Value`) |>
  group_by(Year) |>
  slice_max(`Disparity Value`, n = 100, with_ties = F) |>
  add_count(`Comparing (Focus group)`, name = "n_fg") |>
  mutate(FocusGroup2 = ifelse(n_fg <= 3,
                              "Other",
                              `Comparing (Focus group)`)) |>
  ggplot(aes(x = "", fill = FocusGroup2)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") +
  facet_wrap(~ Year) +
  labs(title = "Share of Top 100 Smoking Disparity Values by Focus Group (2011 vs 2023)",
      x = NULL, y = NULL,
      fill = "Focus Group") +
  theme_void()
```

```{r}
#Graph 10A
tobacco_region |>
  ungroup() |>
  filter(Year == 2023) |>
  select(Demographic, `Comparing (Focus group)`, `Disparity Value`) |>
  group_by(Demographic, `Comparing (Focus group)`) |>
  summarize(avg_disp = mean(`Disparity Value`, na.rm = T)) |>
  filter(avg_disp > 1) |>
  ggplot(aes(x = avg_disp,
             y = reorder(`Comparing (Focus group)`, avg_disp),
             fill = Demographic)) +
  geom_col() + labs(title = "Focus Groups With Average Disparity Values Greater Than 1 in 2023",
                    x = "Average Disparity",
                     y = "Focus Group")
```

```{r}
#Graph 10B
tobacco_region |>
  ungroup() |>
  filter(Year == 2023) |>
  select(Demographic, `Comparing (Focus group)`, `Disparity Value`) |>
  group_by(Demographic, `Comparing (Focus group)`) |>
  summarize(avg_disp = mean(`Disparity Value`, na.rm = T)) |>
  filter(avg_disp < 1) |>
  ggplot(aes(x = avg_disp,
             y = reorder(`Comparing (Focus group)`, -avg_disp),
             fill = Demographic)) +
  geom_col() + labs(title = "Focus Groups With Average Disparity Values Less Than 1 in 2023",
                    x = "Average Disparity",
                     y = "Focus Group")
```


### 3. Requirement - 3 (5 pt)

By this phase, you have a pretty good understanding of your data. Now, you will develop a predictive Machine Learning model to forecast a specified target outcome. For predictor selection, you must apply the feature selection techniques covered in Lectures 19 and 20. Provide a detailed justification for the final set of predictors chosen to receive full credit.

Build an interactive shiny app that allows the user to select or input values and then make predictions using your model. You are required to build the shiny app just for the prediction section of your project. Although we will accept if you create a shiny app for your entire project (not required)


```{r}
library(shiny)
library(dplyr)
library(ggplot2)

# ---- Clean up column names to make more coder friendly ----
tobacco_clean <- tobacco_region %>%
  rename(
    cig_prev    = `Cigarette Use Prevalence % (Focus group)`,
    focus_group = `Comparing (Focus group)`
  )

regions      <- sort(unique(tobacco_clean$region))
focus_groups <- sort(unique(tobacco_clean$focus_group))

# ---- linear model ----
model <- lm(
  cig_prev ~ Year + region + focus_group,
  data = tobacco_clean
)

# Helper function For Later
predict_prev <- function(year, region, focus) {
  newdata <- data.frame(
    Year        = year,
    region      = region,
    focus_group = focus
  )
  as.numeric(predict(model, newdata = newdata))
}

# ---- UI ----
ui <- fluidPage(
  titlePanel("Smoking Risk Comparison Tool"),
  
  sidebarLayout(
    sidebarPanel(
      h3("Group A"),
      selectInput("region_A", "Region", choices = regions),
      selectInput("focus_A", "Focus Group", choices = focus_groups),
      numericInput("year_A", "Year", value = 2030, min = 2023),
      
      hr(),
      
      h3("Group B"),
      selectInput("region_B", "Region", choices = regions),
      selectInput("focus_B", "Focus Group", choices = focus_groups),
      numericInput("year_B", "Year", value = 2030, min = 2023)
    ),
    
    mainPanel(
  h3("Predictions"),
  textOutput("predA"),
  textOutput("predB"),
  hr(),
  
  strong(textOutput("disparitySentence")),
  br(), br(),
  
  h3("Average Smoking Rate Over Time by Region"),
  plotOutput("regionTrendPlot"),
  br(), br(),
  
  # ---- MOVED MODEL EXPLANATION TO THE BOTTOM ----
  tags$em(
    "These predictions are generated from a linear regression model using Year, Region, and Focus Group as predictors."
  )
)

  )
)

# ---- SERVER ----
server <- function(input, output, session) {
  
  output$predA <- renderText({
    predA <- predict_prev(input$year_A, input$region_A, input$focus_A)
    paste("Predicted Prevalence for Group A:", round(predA, 2), "%")
  })
  
  output$predB <- renderText({
    predB <- predict_prev(input$year_B, input$region_B, input$focus_B)
    paste("Predicted Prevalence for Group B:", round(predB, 2), "%")
  })
  
  # ----- Ratio & interpretation -----
  output$disparitySentence <- renderText({
    predA <- predict_prev(input$year_A, input$region_A, input$focus_A)
    predB <- predict_prev(input$year_B, input$region_B, input$focus_B)
    
    if (is.na(predA) || is.na(predB)) {
      return("Cannot compare predicted risks: one of the predictions does not exist.")
    }
    if (predB == 0) {
      return("Cannot compute comparison because Group B's predicted prevalence is 0%.")
    }
    
    ratio <- predA / predB
    

    if (abs(ratio - 1) < 0.02) {
      return("Group A and Group B are approximately equally likely to smoke.")
    }
    
    # Ratio > 1: A more likely
    if (ratio > 1) {
      return(
        paste0("Group A is ", round(ratio, 2),
               " times more likely to smoke than Group B.")
      )
    }
    
    # Ratio < 1: A less likely
    paste0("Group A is ", round(ratio, 2),
           " times as likely to smoke as Group B.")
  })
  
  # ---- Region trend graph ----
  output$regionTrendPlot <- renderPlot({
    tobacco_region |> group_by(`Year`, region) |> 
  summarize(avg = mean(`Cigarette Use Prevalence % (Focus group)`, na.rm = T)) |>
  
  ggplot() + geom_line(aes(x = `Year`, 
                           y = avg, color = region)) +
    labs(title = "Average Smoking Rate Over Time by Focus Group's Region",
         y = "Average Cigarette Smoking Rate (as a %)",
         color = "Region")
  })
}

# ---- Run App ----
shinyApp(ui, server)
```




```{r}
model <- lm(cig_prev ~ Year + region + focus_group, data = tobacco_clean)

summary(model)
## In reviewing the regression output, all predictors used in the model were statistically significant at the 0.05 level with the exception of the Age 18–24 focus-group category, which had a p-value of 0.23. This lack of significance does not indicate a problem with the model. Because Age is included as part of a larger categorical predictor (the broader Focus Group variable), it is normal for some individual categories to be non-significant relative to the baseline. The Age 18–24 group simply does not differ statistically from the reference group, while the other age categories (25–44, 45–64, 65+) show strong significance. The variable as a whole still contributes meaningful explanatory power to the model, so the presence of one non-significant category does not warrant removing the predictor or modifying the model structure.
```

```{r}
state_signif<-lm(
  cig_prev ~ Year + State + focus_group,
  data = tobacco_clean
)
summary(state_signif)

```

### 4. Requirement - 4 (1 pt)

You should have a conclusion, highlighting the main insights you were able to derive from your analysis. 

This is an open ended project where every team will come up with their own unique insights. We would like to see what each team comes up with.

```{r}
cat("
# Requirement 4: Conclusion and Main Insights

## Key Insights From Our Analysis

- **Smoking disparities exist across all demographics**
    - Non-Hispanic AIAN groups smoke the most
    - Non-Hispanic Asian groups smoke the least
    - Lower-income groups and those unable to work show the highest rates

- **Mental health strongly influences smoking**
    - Severe mental distress is associated with much higher
      and more variable smoking rates

- **Regional patterns persist**
    - Midwest and South maintain the highest rates despite declines

- **Smoking has decreased over time**
    - Gaps between demographic groups remain

- **Most at-risk groups include:**
    - Unable to work
    - Income < $20,000
    - Non-Hispanic AIAN
    - Unemployed

- **Least at-risk groups include:**
    - Income > $75,000
    - Homemakers or students
    - Non-Hispanic Asian individuals
- **Demographic information influences tobacco use probability
    more than regional information.**
")
```


## Submission

* You will upload the zip file containing your final.Rmd, final.pdf files covering the EDA and app.R file for your shiny app, as a deliverable to Canvas

* You will present your findings by creating a video of a maximum of 15 minutes duration, explaining the code and the workings of your project; all team members should explain their part in the project to receive credit. You will share the video URL on Canvas for credit.

It is not necessary to prepare slides (if you do it doesn't hurt) for the presentation. You may speak by showing the diagrams and/or code from your laptop.  Every team member should explain their part in the project along with the insights they derived by explaining the charts and summaries for full credit to each member. An easy way to get this accomplished is to open a Zoom meeting and everyone take turns in explaining while you record the meeting. Add the URL of this recording to Canvas.

Your project will be evaluated for its meaningful/insightful EDA and predictions.

------------------------------------------------------------------

## Hints

Some answers you may try to find in this dataset could be:

* Are smoking disparities related to income getting worse or better over time?
* Which racial or ethnic group faces the greatest inequality in smoking rates compared to the majority population?
* Do people with frequent mental distress have a much higher smoking disparity than people with disabilities?
* Which 5 focus groups have the highest average disparity over the entire period?

These questions could just get you started but as an analyst you should hone the skills of asking good questions and this project will get you that practice.


## Machine Learning Model Development:

You could build  a regression model to predict the DisparityValue. Features may include, Year, disparity category, specific focus group etc. Extract and plot the feature importance to select the features. 

## Summary

Your summary might answer questions like; 

* What were the most significant trends and predictors of smoking disparity? 
* Which populations should be prioritized for smoking cessation programs? etc.  
You may also include ideas for future analysis and any limitations you came across with the current dataset


